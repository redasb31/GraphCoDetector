


<h2>D: Complex Oracle - Complex Oracle -</h2>

<h3>問題</h3>
<p>
※この問題はリアクティブ問題です．すなわち，サーバー側に用意されたプログラムと対話的に応答することで正答を導くプログラムを作成する必要があります．
また、サーバー側のプログラムも計算機資源を共有する関係上、サーバーだけで最大 3 sec程度の実行時間、最大 300 MB程度のメモリを使用する場合がありますので、TLE・MLEにお気をつけください。
</p>

<p>あいずにゃんは若ヶ松高校のプログラミングコンテスト部、通称ぷろこん部に所属する2年生である。見目麗しい。あいずにゃんはその小さな体も無限に存在するチャームポイントの1つであるが、本人はコンプレックスを感じているようだ。そのせいか、一列に並んでいる人たちを見ると、それぞれの人の前方にその人より身長が高い人が何人並んでいるかを瞬時に数えられる能力を持っている。</p>

<p>プロコンの名門・律命館大学中等部卒のエリート競技プログラマであり、ぷろこん部の部長であるりっつちゃんは、あいずにゃんのこの能力を使えば、並んでいる人たちがそれぞれ何番目に背が高いのかを当てることができるのではないかと考えた。</p>

<p>今、りっつちゃんは<var>N</var>人が並んでいる列をあいずにゃんに見せている。りっつちゃんは、人が<var>N</var>人並んでいることは知っているが、その並び順がどうなっているかはわからない。りっつちゃんはあいずにゃんに “<var>l</var>番目の人から<var>r</var>番目の人までコンプレックス度” を教えてもらうことができる。ここで、<var>l</var>番目の人から<var>r</var>番目の人までのコンプレックス度とは、<var>i</var> (<var>l \&le; i \&le; r</var>) 番目の人それぞれに関して、<var>l</var>番目から<var>i &minus; 1</var>番目までの間にいる自分 (<var>i</var>) より背が高い人の人数の総和である。(より厳密な定義は入出力形式を参照のこと)</p>

<p>(うらやましいことに) ぷろこん部の部員であるあなたは、(とても、とても心苦しいが) あいずにゃんをオラクルとして利用することで身長順を当てるプログラムを書くようりっつちゃんに命じられた。つらい。せめてあいずにゃんに負担をかけないよう、少ない質問回数で求められるよう頑張ろう。</p>

<h3>入力出力形式</h3>
<p>サーバーは背の順を表す長さ<var>N</var>の数列<var>p</var>を保持している。これは入力として与えられない。<var>p</var>の各要素<var>p_i</var>は<var>1</var>以上<var>N</var>以下であり、それぞれ値は異なる。<var>p_i</var>が大きい値を持つ方が背が高いことを表す。</p>

<p>サーバーはまず、<var>p</var>の長さ<var>N</var>を表す<var>1</var>つの整数からなる<var>1</var>行を入力として解答プログラムに与える。</p>

<p>次に解答プログラムが<var>2</var>つの整数 <var>l, r</var> (<var>1 \&le; l \&le; r \&le; N</var>) からなるクエリをサーバーに送る。クエリの出力形式は</p>

<pre>? <var>l</var> <var>r</var></pre>

<p>である。これは例えばC/C++だと、</p>

<pre>printf("? %d %d\n", l, r); fflush(stdout);</pre>

<p>などと書けばよい。出力の度にフラッシュすることを推奨する。</p>

<p>すると、サーバー側は以下の値を表す<var>1</var>つの整数<var>C</var>からなる1行を入力として解答プログラムに与える。</p>

<pre><var>C = (\{ (i, j) | p_i &gt; p_j</var> <var>{\rm for}</var> <var>l \&le; i&lt;j \&le; r \}の要素数)</var></pre>

<p>ただし、クエリとして正しくない<var>l, r</var> (<var>l, r</var>が<var>1</var>以上<var>N</var>以下の数ではない、または<var>l&gt;r</var>である) が与えられた場合、サーバーは<var>&minus;1</var>を<var>C</var>として返す。</p>

<p>この応答を何度か繰り返し、解答プログラムが<var>p</var>を推定できたならば、<var>p</var>を以下の形式で出力する。</p>

<pre>! <var>p_1</var> ... <var>p_N</var></pre>

<p>推定した順列の出力は1度しかできず、この出力が<var>p</var>と異なる場合、誤答となる。200,000回以内のクエリで正しい<var>p</var>を出力できた場合、正答となる。</p>

<p>各クエリで改行を行うよう気をつけること。</p>

<h3>入力制約</h3>
<ul>
<li><var>1 \&le; N \&le; 100,000</var></li>
<li>推定される長さ<var>N</var>の数列<var>p</var>は順列。すなわち、<var>p_i \in \{1, </var> ... <var>, N\}</var> <var>{\rm for}</var> <var>1 \&le;  i \&le; N</var>、および<var>p_i \neq p_j</var> <var>{\rm for}</var> <var>1 \&le; i &lt; j \&le; N</var> を満たす</li>
<li>サーバーへのクエリ回数は200,000回まで</li>
<li>サーバーから返答される<var>C</var>は32bit整数型では収まらない大きさになりうることに注意せよ</li>
</ul>

<h3>入力出力例</h3>
<pre>
<table width="600" class="withborder"><tbody>
<tr><th>サーバーの出力 </th><th> サーバーへの入力</th></tr>
<tr><td>4 </td><td> </td></tr>
<tr><td> </td><td> ? 1 3 </td></tr>
<tr><td> 2 </td><td> </td></tr>
<tr><td> </td><td> ? 2 4 </td></tr>
<tr><td> 1 </td><td> </td></tr>
<tr><td> ... </td><td> ... </td></tr>
<tr><td> </td><td> ! 4 1 3 2 </td></tr>
</tbody></table>
</pre>